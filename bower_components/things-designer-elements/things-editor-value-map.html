<link rel="import" href="../polymer/polymer.html">

<!--
An element providing a solution to no problem in particular.

Example:

  <things-editor-value-map map="{{rule.map}}"
                           key-type="[[type]]"
                           value-type="[[valueType]]">
  </things-editor-value-map>

@demo demo/index-editor-value-map-color.html
@demo demo/index-editor-value-map.html
@hero hero.svg
-->

<dom-module id="things-editor-value-map">
  <template>
    <style>
      :host {
        display: block;
        width:94%;
        overflow:hidden;
        clear:both;
        margin:7px 0 0 7px;
        border:1px solid #ccc;
      }
      *{float:left;}
      input{
        width:40%;
        margin:3px 0 3px 3px;
      }
      input[data-value-type='color']{width:28%;}
      input[type='color']{width:10%;}
      div{border-bottom:1px solid #c0c0c0;}
      div:last-child{border-bottom:none;}
      .record-action{
        background-color:rgba(0,0,0,.5);
        border-radius:50%;
        border:none;
        margin:5px 0 0 4px;
        width:15px;height:15px;
        cursor:pointer;
        color:#fff;
        font-size:14px;
        line-height:0;
        text-indent:-3px;
      }
    </style>

    <template is="dom-repeat" items="{{_toArray(map)}}">
      <div data-record>
        <input type="text" data-key placeholder="key" value="{{item.key}}"/>
        <input type="text" data-value placeholder="value" value="{{item.value}}" data-value-type$="[[valueType]]"/>
        <template is="dom-if" if="[[_isColorType(valueType)]]">
          <input type="color" data-value value="{{item.value}}" tabindex="-1"/>
        </template>
        <button class="record-action" on-tap="_delete" tabindex="-1">-</button>
      </div>
    </template>

    <div data-record-new>
      <input type="text" data-key placeholder="key" value=""/>
      <input type="text" data-value placeholder="value" value="" data-value-type$="[[valueType]]"/>
      <template is="dom-if" if="[[_isColorType(valueType)]]">
        <input type="color" data-value value="" tabindex="-1"/>
      </template>
      <button class="record-action" on-tap="_add" tabindex="-1">+</button>
    </div>

    <div data-record>
      <input type="text" data-key value="default" disabled/>
      <input type="text" data-value value="{{map.default}}" placeholder="value" data-value-type$="[[valueType]]"/>
      <template is="dom-if" if="[[_isColorType(valueType)]]">
        <input type="color" data-value value="{{map.default}}" tabindex="-1"/>
      </template>
      <button class="record-action" on-tap="_sort" tabindex="-1">&gt;</button>
    </div>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'things-editor-value-map',

        properties: {
          map: {
            type: Object,
            notify: true,
            value: {}
          },
          keyType: {
            notify: true,
            value: 'string'
          },
          valueType: {
            notify: true,
            value: 'string'
          }
        },

        listeners: {
          'change': '_onChange'
        },

        _isColorType: function(type) {
          return type === 'color'
        },

        _onChange: function(e) {
          var input = e.target
          var value = e.target.value
          var div = input.parentElement

          if(input.hasAttribute('data-value')) {
            var dataList = div.querySelectorAll('[data-value]')
            for(var i = 0;i < dataList.length;i++)
              if(dataList[i] !== input)
                dataList[i].value = value
          }

          if(div.hasAttribute('data-record'))
            this._build()
          else if(div.hasAttribute('data-record-new') && input.hasAttribute('data-value'))
            this._add()
        },

        _build: function(includeNewRecord) {
          if(includeNewRecord)
            var records = this.querySelectorAll('[data-record],[data-record-new]')
          else
            var records = this.querySelectorAll('[data-record]')

          var newmap = {}

          for(var i = 0;i < records.length;i++) {
            var record = records[i]

            var key = record.querySelector('[data-key]').value
            var value = record.querySelector('[data-value]').value

            if(key)
              newmap[key] = value
          }

          this.set('map', newmap)
        },

        /* default를 제외한 map아이템들을 template(dom-repeat)용 배열로 변환하는 함수 */
        _toArray: function(map) {
          var array = []

          for(var key in map) {
            if(key == 'default')
              continue
            array.push({
              key: key,
              value: map[key]
            })
          }

          return array
        },

        _sort: function(e) {

          var sorter = this.keyType === 'number' ?
            function(a, b) {
              return parseFloat(b.key) < parseFloat(a.key)
            } :
            function(a, b) {
              return b.key < a.key
            }

          var map = this._toArray(this.map).sort(sorter).reduce(function(sum, i) {
            sum[i.key] = i.value
            return sum
          }, {})

          map.default = this.map.default

          this.set('map', map)
        },

        _add: function(e) {
          this._build(true)

          var inputs = this.querySelectorAll('[data-record-new] input')

          for (var i = 0;i < inputs.length;i++)
            inputs[i].value = ''

          inputs[0].focus()
        },

        _delete: function(e) {
          var record = e.target.parentElement
          record.querySelector('[data-key]').value = ''
          this._build()
        }

      });
    })();
  </script>
</dom-module>
