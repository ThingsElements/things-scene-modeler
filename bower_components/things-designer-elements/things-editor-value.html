<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">

<link rel="import" href="../juicy-ace-editor/juicy-ace-editor.html">

<link rel="import" href="./things-editor-value-map.html">
<link rel="import" href="./things-editor-value-range.html">

<!--
An element providing a solution to no problem in particular.

Example:

  <things-editor-value mapping="{{mapping}}"
                       type="[[type]]">
  </things-editor-value>

@demo demo/index-editor-value.html
@hero hero.svg
-->

<dom-module id="things-editor-value">
  <template>
    <style>
      :host {
        display: block;
        max-width:229px;
        min-width:229px;
        background-color:rgba(255,255,255,.5);;
        overflow:hidden;
        margin:0 0 0 5px;
        padding:0 0 5px 0;
        border:1px solid rgba(0,0,0,.2);
        border-width:0 1px 1px 1px;
      }

      :host .content{background-color:rgba(255,255,255,.5);}

      paper-radio-button{padding:2px 2px 2px 5px !important;}
      paper-radio-button::shadow #radioLabel{
        margin-left:0 !important;
        color:#607D8B !important;
        font-size:12px;
      }
      paper-radio-button::shadow #offRadio.paper-radio-button{
        border-color:#aaa;
        border-width:1px;
        width:10px;height:10px;
        top:2px;
        left:2px;
      }
      paper-radio-button::shadow #onRadio.paper-radio-button{background-color:#26A69A;}
      paper-radio-button[checked]::shadow #offRadio.paper-radio-button{border-color:#26A69A;}

      paper-radio-group{width:69%;float:left;}

      juicy-ace-editor{
        width:94%;height:300px;
        margin:7px 0 0 7px;
        overflow:auto;
      }
    </style>

    <label>target</label>
    <input data-mapping-target type="text" value="{{mapping.target::change}}"/>

    <label>property</label>
    <select value="{{mapping.property::change}}">
      <option>text</option>
      <option>fillStyle</option>
      <option>strokeStyle</option>
      <option>fontColor</option>
      <option>rotation</option>
      <option>hidden</option>
    </select>

    <label>rule type</label>
    <paper-radio-group selected="{{mapping.rule}}">
      <paper-radio-button name="value">value</paper-radio-button>
      <paper-radio-button name="map">map</paper-radio-button>
      <paper-radio-button name="range">range</paper-radio-button>
      <paper-radio-button name="eval">eval</paper-radio-button>
    </paper-radio-group>

    <iron-pages attr-for-selected="data-rule-type"
                selected="{{mapping.rule}}"
                class="content">
      <things-editor-value-map data-rule-type="map"
                               map="{{rule.map}}"
                               key-type="[[type]]"
                               value-type="[[valueType]]">
      </things-editor-value-map>

      <things-editor-value-range data-rule-type="range"
                                 range="{{rule.range}}"
                                 range-type="[[type]]"
                                 value-type="[[valueType]]">
      </things-editor-value-range>

      <div data-rule-type="eval">
        <!-- ace-editor의 TEXT부분에 공백이 추가되지 않도록 {{rule.eval}}주의에 공백을 주지않도록 해야함. -->
        <juicy-ace-editor id="eval-editor"
        theme="ace/theme/monokai" mode="ace/mode/javascript"
        >{{rule.eval}}</juicy-ace-editor>
      </div>
    </iron-pages>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'things-editor-value',

        properties: {
          mapping: {
            type: Object,
            notify: true
          },
          type: {
            notify: true
          }
        },

        observers: [
          'onChangedMapping(mapping.*)',
          'onChangedRule(rule.*)',
          '_valueType(mapping.property)'
        ],

        listeners: {
          'eval-editor.blur': 'onBlurEvalEditor',
          'eval-editor.editor-ready': 'onEditorReady'
        },

        onEditorReady: function(e) {
          // event.detail should be a ace-editor
          e.detail.renderer.setShowGutter(false);
        },

        onBlurEvalEditor: function(after) {
          this.set('rule.eval', this.$['eval-editor'].value)
        },

        _valueType: function(property){
          switch(property) {
          case 'hidden':
            this.valueType = 'boolean'
            break
          case 'rotation':
            this.valueType = 'number'
            break
          case 'fillStyle':
          case 'strokeStyle':
          case 'fontColor':
            this.valueType = 'color'
            break
          case 'text':
          default:
            this.valueType = 'string'
            break
          }
        },

        onChangedMapping: function(change) {

          /* 사용자가 선택한 컴포넌트가 바뀐 경우도 호출되므로, 이 경우는 제외한다. */
          if(change.path === 'mapping') {
            var rule = {}

            if(this.mapping) {
              switch(this.mapping.rule) {
              case 'map':
                rule.map = this.mapping.param || {}
                break
              case 'range':
                rule.range = this.mapping.param || []
                break
              case 'eval':
                rule.eval = this.mapping.param || ''
                break
              }
            }

            this.set('rule', rule)

            this.querySelector('[data-mapping-target]').focus()

            return
          }

          var param

          if(change.path == 'mapping.rule') {
            switch(this.mapping.rule) {
            case 'map':
              param = this.rule.map
              break
            case 'range':
              param = this.rule.range
              break
            case 'eval':
              param = this.rule.eval || ''

              // rule.eval에 값이 없을 때, ace-editor 내용이 초기화되지 않는 문제때문에 처리함.
              if(!param)
                this.$['eval-editor'].editor.setValue(param)
              break
            default:
              param = null
            }

            this.set('mapping.param', param)
          }
        },

        onChangedRule: function(change) {

          if(!this.mapping)
            return

          var param

          switch(this.mapping.rule) {
          case 'map':
            param = this.rule.map
            break
          case 'range':
            param = this.rule.range
            break
          case 'eval':
            param = this.rule.eval || ''
            break
          default:
            param = null
          }

          this.set('mapping.param', param)
        }
      })

    })();

  </script>
</dom-module>
